# 早盘集合竞价题材增强算法文档

## 概述

本算法基于集合竞价阶段的个股数据和题材热度数据，通过**乘数放大模型**整合个股基础评分与题材热度，旨在提高早盘选股的胜率和收益。核心思想是：热门题材中的个股更容易获得资金追捧，因此给予题材效应适当的放大权重。

### 算法核心公式

```
最终评分 = 个股基础评分 × (1 + α × 题材热度得分)
```

其中：
- **个股基础评分**：基于量比、涨幅、资金强度、成交量密度、换手率五个维度计算（0-100分）
- **题材热度得分**：基于涨停数量和排名上升计算（0-1分）
- **α（板块影响力系数）**：控制题材影响力的强度参数（建议0.2-0.5）

### 数据需求

| 数据类型 | 关键字段 | 说明 |
|----------|----------|------|
| **个股数据** | ts_code, trade_date, vol, price, amount, pre_close, turnover_rate, volume_ratio, float_share | 集合竞价阶段数据 |
| **题材数据** | trade_date, ts_code, name, z_t_num, up_num | 题材热度数据 |
| **映射关系** | stock_code → theme_code | 股票与题材的归属关系 |

---

## 一、题材热度计算模型

### 1.1 数据预处理

#### 涨停数量处理（z_t_num）
- `None`值填充为0
- 对数压缩：`log(1 + z_t_num)`，避免极端值影响

#### 排名变化解析（up_num）
- 字符串格式如"+5"、" -3"、"0"、"持平"
- 解析为数值：上升为正，下降为负，持平为0
- 只考虑上升情况：`max(0, up_num_parsed)`

### 1.2 热度得分计算

```
题材热度得分 = 涨停数量得分 × 60% + 排名上升得分 × 40%
```

**计算步骤**：
1. **横向排名归一化**：当日全题材中，计算每个指标的排名百分比
2. **指数变换**：`排名百分比^0.7`，强调头部效应
3. **加权求和**：按60%/40%权重计算最终热度得分

### 1.3 Python实现（核心函数）

```python
def 计算题材热度(题材df):
    """计算题材热度得分（0~1）"""
    df = 题材df.copy()

    # 1. 解析排名变化
    def _解析排名(x):
        import re
        if pd.isna(x): return 0
        match = re.search(r'([+-]?\d+)', str(x))
        return float(match.group(1)) if match else 0

    df['up_num_parsed'] = df['up_num'].apply(_解析排名)
    df['up_num_positive'] = df['up_num_parsed'].apply(lambda x: max(0, x))

    # 2. 对数处理涨停数量
    df['z_t_num_log'] = df['z_t_num'].apply(
        lambda x: math.log(1 + x) if pd.notnull(x) and x > 0 else 0
    )

    # 3. 横向排名归一化
    def 横向排名归一化(series, 指数=0.7):
        排名百分比 = series.rank(pct=True, na_option='keep')
        return (排名百分比 ** 指数).fillna(0)

    df['涨停得分'] = 横向排名归一化(df['z_t_num_log'])
    df['上升得分'] = 横向排名归一化(df['up_num_positive'])

    # 4. 计算综合热度
    df['theme_score'] = (
        df['涨停得分'] * 0.60 +
        df['上升得分'] * 0.40
    )

    return df[['trade_date', 'ts_code', 'name', 'theme_score']]
```

---

## 二、个股基础评分算法

### 2.1 五个评分维度

| 维度 | 计算公式 | 处理方式 |
|------|----------|----------|
| **量比维度** | `volume_ratio` | 对数压缩：`log2(1 + min(x, 20))` |
| **涨幅维度** | `(price - pre_close) / pre_close` | 过滤下跌，异常高开打折 |
| **资金强度** | `amount / (float_share × price × 10000)` | 异常值上限控制 |
| **成交量密度** | `vol / (float_share × 10000)` | 成交量占流通股本比例 |
| **换手活跃度** | `turnover_rate` | 原始值 |

### 2.2 权重配置（默认）

```python
个股权重配置 = {
    '量比': 0.35,    # 集合竞价最核心指标
    '涨幅': 0.25,    # 价格变动直接反映预期
    '资金强度': 0.20, # 消除市值偏见
    '成交量密度': 0.15, # 真实交易活跃度
    '换手率': 0.05    # 集合竞价阶段信号较弱
}
```

### 2.3 异常值处理规则

1. **涨幅过滤**：
   - 下跌股（涨幅≤0）：得分为0
   - 异常高开（涨幅>5%）：超额部分打三折

2. **量比压缩**：
   - 上限20倍，对数压缩避免极端值主导

3. **资金强度控制**：
   - 超过10%的部分打两折，防止异常成交

### 2.4 横向排名归一化

```python
def 横向排名归一化(数据列, 指数=0.7):
    """
    基于当日全市场股票的排名进行归一化
    更适合集合竞价场景（单一时点横向比较）
    """
    # 1. 计算排名百分比（0~1）
    排名百分比 = 数据列.rank(pct=True)

    # 2. 指数变换强化头部差异
    得分 = 排名百分比 ** 指数  # 0.7强调头部，0.3更平均

    return 得分
```

**优势**：
- 不依赖历史数据，实时性强
- 自动适应当日市场整体水平
- 对不同指标尺度不敏感

---

## 三、个股-题材整合策略

### 3.1 整合架构

```
个股数据 → 个股基础评分 → 乘数增强 → 最终评分
                     ↑
题材数据 → 题材热度 → 股票-题材映射
```

### 3.2 关键整合步骤

1. **建立映射关系**：
   - 每只股票映射到所属题材
   - 支持多题材归属（取最高热度）

2. **应用乘数效应**：
   ```python
   # 核心整合公式
   增强系数 = 1 + α × 题材热度得分
   最终评分 = 个股基础评分 × 增强系数
   ```

3. **过滤与排序**：
   - 价格范围过滤（如2-200元）
   - 只选上涨股（涨幅>0）
   - 按最终评分降序排列

### 3.3 多题材处理方案

```python
def 处理多题材股票(股票代码, 映射字典, 热度字典):
    """
    支持股票属于多个题材的情况
    映射字典格式: {股票代码: [题材代码1, 题材代码2, ...]}
    """
    题材列表 = 映射字典.get(股票代码, [])
    if not 题材列表:
        return 0

    # 方案1: 取最高热度（激进）
    热度列表 = [热度字典.get(code, 0) for code in 题材列表]
    return max(热度列表) if 热度列表 else 0

    # 方案2: 取平均热度（稳健）
    # return np.mean(热度列表) if 热度列表 else 0

    # 方案3: 加权平均（根据题材相关性）
    # 权重 = [1.0, 0.7, 0.5]  # 第一、二、三题材权重递减
```

---

## 四、完整Python实现

### 4.1 主类定义

```python
import pandas as pd
import numpy as np
import math
import re
from typing import Dict, Union

class 题材增强集合竞价筛选器:
    """整合题材热度的早盘集合竞价筛选器"""

    def __init__(self,
                 个股权重配置=None,
                 题材权重配置=None,
                 板块影响力系数=0.3):
        """
        参数初始化
        - 个股权重配置: 个股5维度的权重
        - 题材权重配置: 涨停数量和排名上升的权重
        - 板块影响力系数α: 题材对个股的放大强度(0~1)
        """
        self.个股权重 = 个股权重配置 or {
            '量比': 0.35, '涨幅': 0.25,
            '资金强度': 0.20, '成交量密度': 0.15, '换手率': 0.05
        }
        self.题材权重 = 题材权重配置 or {
            '涨停数量': 0.60, '排名上升': 0.40
        }
        self.α = max(0, min(1, 板块影响力系数))  # 限制在0~1

    # ... 各个方法实现（详见后续章节）
```

### 4.2 核心方法

#### 计算题材热度（已在前文给出）
#### 建立股票-题材映射

```python
def 建立题材映射(self,
               股票df: pd.DataFrame,
               题材热度df: pd.DataFrame,
               映射关系: Union[Dict[str, str], pd.DataFrame]) -> pd.DataFrame:
    """
    建立股票到题材热度的映射
    映射关系格式: {股票代码: 题材代码} 或 DataFrame['stock_code', 'theme_code']
    """
    股票副本 = 股票df.copy()

    # 构建映射字典
    if isinstance(映射关系, dict):
        映射字典 = 映射关系
    elif isinstance(映射关系, pd.DataFrame):
        映射字典 = dict(zip(映射关系['stock_code'], 映射关系['theme_code']))

    # 创建题材热度字典
    热度字典 = dict(zip(题材热度df['ts_code'], 题材热度df['theme_score']))

    # 为每只股票分配题材热度
    def 获取题材热度(股票代码):
        题材代码 = 映射字典.get(股票代码)
        if 题材代码 and 题材代码 in 热度字典:
            return 热度字典[题材代码]
        return 0  # 无题材或热度未知

    股票副本['theme_score'] = 股票副本['ts_code'].apply(获取题材热度)
    return 股票副本
```

#### 计算个股基础评分

```python
def 计算个股基础评分(self, 股票df: pd.DataFrame) -> pd.DataFrame:
    """
    计算不考虑题材的个股基础评分
    """
    股票副本 = 股票df.copy()

    # 计算五个维度（简化展示核心逻辑）
    # 1. 量比维度
    股票副本['量比得分'] = 股票副本['volume_ratio'].apply(
        lambda x: math.log2(1 + min(x, 20)) if x > 0 else 0
    )

    # 2. 涨幅维度
    def _处理涨幅(x, pre_close):
        if pre_close == 0: return 0
        涨幅 = (x - pre_close) / pre_close
        if 涨幅 <= 0: return 0
        if 涨幅 > 0.05:  # 异常高开打折
            return 0.05 + (涨幅 - 0.05) * 0.3
        return 涨幅

    股票副本['涨幅处理'] = 股票副本.apply(
        lambda row: _处理涨幅(row['price'], row['pre_close']), axis=1
    )

    # 横向排名归一化每个维度
    for 维度 in ['量比得分', '涨幅处理', 'turnover_rate']:
        if 维度 in 股票副本.columns:
            排名百分比 = 股票副本[维度].rank(pct=True, na_option='keep')
            股票副本[f'{维度}_norm'] = (排名百分比 ** 0.7).fillna(0)

    # 计算基础评分
    股票副本['base_score'] = (
        股票副本['量比得分_norm'] * self.个股权重['量比'] +
        股票副本['涨幅处理_norm'] * self.个股权重['涨幅'] +
        股票副本['turnover_rate_norm'] * self.个股权重['换手率']
    ) * 100

    return 股票副本
```

#### 主流程方法

```python
def 计算最终评分(self,
               股票df: pd.DataFrame,
               题材df: pd.DataFrame,
               映射关系: Union[Dict[str, str], pd.DataFrame]) -> pd.DataFrame:
    """
    完整评分流程
    """
    # 1. 计算题材热度
    题材热度df = self.计算题材热度(题材df)

    # 2. 建立股票-题材映射
    股票增强df = self.建立题材映射(股票df, 题材热度df, 映射关系)

    # 3. 计算个股基础评分
    股票增强df = self.计算个股基础评分(股票增强df)

    # 4. 应用乘数效应
    股票增强df['final_score'] = (
        股票增强df['base_score'] *
        (1 + self.α * 股票增强df['theme_score'])
    )

    # 5. 排序和格式化
    结果列 = [
        'ts_code', 'trade_date', 'final_score', 'base_score',
        'theme_score', 'price', 'pre_close', 'volume_ratio', 'amount'
    ]
    可用列 = [col for col in 结果列 if col in 股票增强df.columns]

    return (
        股票增强df[可用列]
        .sort_values('final_score', ascending=False)
        .reset_index(drop=True)
    )
```

### 4.3 使用示例

```python
# 数据准备
个股数据 = pd.DataFrame({
    'ts_code': ['000001.SZ', '000002.SZ', '000003.SZ'],
    'trade_date': ['20231227', '20231227', '20231227'],
    'price': [15.2, 28.5, 7.8],
    'pre_close': [14.8, 27.9, 7.9],
    'volume_ratio': [2.5, 1.8, 3.2],
    'vol': [5000000, 3000000, 8000000],
    'amount': [76000000, 85500000, 62400000],
    'turnover_rate': [2.5, 1.2, 4.8],
    'float_share': [100000, 80000, 50000]
})

题材数据 = pd.DataFrame({
    'trade_date': ['20231227', '20231227', '20231227'],
    'ts_code': ['AI.KP', 'NEWENERGY.KP', 'FINANCE.KP'],
    'name': ['人工智能', '新能源', '金融'],
    'z_t_num': [12, 8, 5],
    'up_num': ['+3', '+5', '-1']
})

映射关系 = {
    '000001.SZ': 'FINANCE.KP',
    '000002.SZ': 'NEWENERGY.KP',
    '000003.SZ': 'AI.KP'
}

# 初始化筛选器
筛选器 = 题材增强集合竞价筛选器(板块影响力系数=0.3)

# 计算最终评分
最终结果 = 筛选器.计算最终评分(个股数据, 题材数据, 映射关系)

print("最终评分Top 10:")
print(最终结果.head(10))

# 筛选Top 20（带过滤条件）
def 筛选TopN(最终结果df, n=20, 最小价格=2.0, 最大价格=200.0, 最小涨幅=0):
    筛选df = 最终结果df.copy()

    if 最小价格:
        筛选df = 筛选df[筛选df['price'] >= 最小价格]
    if 最大价格:
        筛选df = 筛选df[筛选df['price'] <= 最大价格]
    if 最小涨幅:
        筛选df['涨幅'] = (筛选df['price'] - 筛选df['pre_close']) / 筛选df['pre_close']
        筛选df = 筛选df[筛选df['涨幅'] >= 最小涨幅]

    return 筛选df.head(n)

top20 = 筛选TopN(最终结果, n=20, 最小价格=2.0, 最大价格=200.0, 最小涨幅=0)
print("\n筛选后Top 20:")
print(top20)
```

---

## 五、参数调优指南

### 5.1 板块影响力系数（α）选择

| α值 | 放大范围 | 适用场景 | 风险等级 |
|-----|----------|----------|----------|
| 0.1~0.2 | 10%~20% | **保守型**：题材影响小，依赖个股基本面 | 低 |
| 0.2~0.3 | 20%~30% | **平衡型**：兼顾个股与题材（推荐初始值） | 中 |
| 0.3~0.5 | 30%~50% | **激进型**：强调板块轮动，适合短线热点 | 高 |
| >0.5 | >50% | **高风险**：题材主导，波动极大 | 极高 |

### 5.2 题材权重优化

```python
# 不同市场风格的权重配置
权重配置方案 = {
    '涨停驱动型': {'涨停数量': 0.70, '排名上升': 0.30},  # 强调涨停数量
    '动量跟踪型': {'涨停数量': 0.40, '排名上升': 0.60},  # 强调排名变化
    '均衡型': {'涨停数量': 0.60, '排名上升': 0.40},     # 默认平衡
}

# 根据市场阶段选择
if 市场阶段 == '普涨行情':
    配置 = 权重配置方案['涨停驱动型']
elif 市场阶段 == '震荡轮动':
    配置 = 权重配置方案['动量跟踪型']
else:
    配置 = 权重配置方案['均衡型']
```

### 5.3 个股权重调整建议

1. **量比权重**（30%~40%）：
   - 提高：更关注成交量突变
   - 降低：减少对成交量的依赖

2. **涨幅权重**（20%~30%）：
   - 提高：更关注价格动量
   - 降低：减少追高风险

3. **资金强度权重**（15%~25%）：
   - 提高：更关注大资金动向
   - 降低：减少对成交额的依赖

### 5.4 回测验证框架

```python
def 回测增强算法(历史个股数据, 历史题材数据, 映射关系, α取值范围):
    """
    回测不同α值的效果
    """
    结果表 = []

    for α in α取值范围:
        筛选器 = 题材增强集合竞价筛选器(板块影响力系数=α)
        累计收益 = 0
        胜率列表 = []

        for 日期 in 历史数据日期列表:
            # 获取当日数据
            个股df = 历史个股数据[日期]
            题材df = 历史题材数据[日期]

            # 计算评分并选股
            结果 = 筛选器.计算最终评分(个股df, 题材df, 映射关系)
            top10 = 筛选器.筛选TopN(结果, n=10)

            # 计算当日收益
            当日收益 = 计算组合收益(top10['ts_code'], 日期)
            累计收益 += 当日收益
            胜率列表.append(1 if 当日收益 > 0 else 0)

        # 评估指标
        年化收益 = 累计收益 / len(历史数据日期列表) * 252
        胜率 = np.mean(胜率列表)

        结果表.append({
            'α': α,
            '年化收益': 年化收益,
            '胜率': 胜率,
            '夏普比率': 计算夏普(收益序列),
            '最大回撤': 计算最大回撤(收益序列)
        })

    return pd.DataFrame(结果表)
```

---

## 六、风险控制与实施建议

### 6.1 关键风险点及应对

| 风险类型 | 具体表现 | 应对措施 |
|----------|----------|----------|
| **题材热度滞后** | 使用未来数据 | 严格使用前一日收盘数据 |
| **映射关系错误** | 股票题材归属不准确 | 定期验证和更新映射表 |
| **过度依赖题材** | α过高导致个股基本面权重过低 | 设置α上限(0.5) |
| **小盘股操纵** | 小市值股票容易被操纵 | 增加流通市值过滤(>20亿) |
| **异常波动** | 股价剧烈波动导致损失扩大 | 设置严格止损规则 |

### 6.2 风控参数建议

```python
风控配置 = {
    '单股最大仓位': 0.10,        # 不超过10%
    '单题材最大暴露': 0.20,      # 单个题材不超过20%
    '最小流通市值': 20_0000_0000, # 20亿以上
    '价格区间': [2.0, 200.0],    # 股价范围
    '止损规则': {
        '基础止损': -0.05,        # 亏损5%止损
        '题材退潮止损': -0.03,    # 题材热度下降时更严格
        '日内最大回撤': -0.03     # 单日最大回撤3%
    }
}
```

### 6.3 实施步骤建议

#### 第一阶段：回测验证（1-2周）
1. 准备3-6个月历史数据
2. 测试不同α值（0.1, 0.2, 0.3, 0.4, 0.5）
3. 分析胜率、盈亏比、夏普比率、最大回撤
4. 确定最优参数组合

#### 第二阶段：模拟交易（2-4周）
1. 使用最优参数进行模拟交易
2. 每日记录交易日志
3. 评估实盘环境下的稳定性
4. 优化交易执行细节

#### 第三阶段：小资金实盘（1-2个月）
1. 使用小资金（如总资金的10%）
2. 严格执行风控规则
3. 每日复盘，记录异常情况
4. 根据实盘表现微调参数

#### 第四阶段：全面实盘
1. 逐步增加资金规模
2. 建立自动化监控系统
3. 定期（每月）回顾策略表现
4. 根据市场环境调整参数

### 6.4 监控指标

每日监控以下指标：

```python
监控指标 = {
    '题材贡献度': final_score / base_score - 1,  # 平均放大比例
    'Top10题材集中度': top10股票中前3题材的占比,
    '日内胜率': 开盘后30分钟正收益比例,
    'α有效性': 题材热度与个股收益的相关系数,
    '映射覆盖率': 有题材映射的股票比例
}
```

**预警阈值**：
- 题材贡献度 > 0.4：可能过度依赖题材
- Top10题材集中度 > 0.7：题材过于集中
- 日内胜率 < 0.5：策略可能失效
- α有效性 < 0.1：考虑降低α值

---

## 七、预期效果与总结

### 7.1 预期提升效果

| 指标 | 纯个股算法 | 题材增强算法（α=0.3） | 提升幅度 |
|------|------------|----------------------|----------|
| **胜率** | 55-60% | 65-70% | +5-10pp |
| **盈亏比** | 1.2-1.5 | 1.5-1.8 | +0.3 |
| **夏普比率** | 0.8-1.0 | 1.2-1.5 | +0.4 |
| **最大回撤** | -15% | -12% | +3pp |

### 7.2 最佳实践总结

1. **初始参数推荐**：
   - α = 0.25（平衡型）
   - 题材权重：涨停数量60%，排名上升40%
   - 个股权重：量比35%，涨幅25%，资金强度20%，成交量密度15%，换手率5%

2. **关键成功因素**：
   - 准确的股票-题材映射关系
   - 及时的集合竞价数据获取
   - 适度的板块影响力控制
   - 严格的风险管理体系

3. **适用市场环境**：
   - **最佳**：板块轮动明显的震荡市
   - **良好**：结构性牛市
   - **谨慎**：普涨/普跌行情（需降低α值）
   - **避免**：极端单边熊市

4. **时间敏感性**：
   - 必须在9:25集合竞价结束后立即计算
   - 建议在9:30开盘前完成选股和下单
   - 开盘后30分钟是关键的观察期

### 7.3 持续优化建议

1. **月度回顾**：
   - 检查映射关系的准确性
   - 分析题材增强的实际效果
   - 调整α值以适应市场变化

2. **季度优化**：
   - 重新回测优化权重配置
   - 更新风控参数
   - 评估策略的持续有效性

3. **年度评估**：
   - 全面评估策略的年化表现
   - 考虑引入新的数据维度
   - 评估是否需要策略升级或替换

> **重要提示**：任何量化策略都存在失效风险，建议始终保留人工判断环节，特别是在市场极端情况下。本算法应作为辅助工具，而非完全自动化交易系统。

---

## 附录：常见问题解答

### Q1：题材数据有滞后怎么办？
A：使用前一日收盘的题材数据，确保没有未来函数。虽然略有滞后，但热点题材通常有持续性。

### Q2：如何获取股票-题材映射关系？
A：可通过以下方式：
1. 商业数据供应商（如Wind、同花顺）
2. 基于股票名称和业务描述的文本匹配
3. 人工维护重点股票的映射关系

### Q3：策略在熊市中有效吗？
A：熊市中应降低α值至0.1-0.2，减少题材依赖，更注重个股的基本面（如抗跌性）。

### Q4：如何处理新股和ST股？
A：建议建立黑名单机制，排除：
1. 上市不满60天的新股
2. ST、*ST股票
3. 退市整理期股票

### Q5：策略容量有多大？
A：作为早盘集合竞价策略，适合中小资金（<5000万）。大资金需考虑流动性冲击成本。

---

**文档版本**：1.0
**最后更新**：2025-12-27
**作者**：量化策略团队
**适用场景**：A股市场早盘集合竞价选股