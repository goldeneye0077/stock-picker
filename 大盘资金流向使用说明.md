# 大盘资金流向功能使用说明

## 功能概述

新增了大盘资金流向分析功能，使用东财（东方财富）的市场资金流向数据，提供更准确的市场整体资金流向分析。

### 数据来源
- **接口**: Tushare Pro `moneyflow_mkt_dc`
- **数据提供商**: 东方财富（East Money）
- **更新频率**: 每日收盘后更新

### 数据内容
1. **市场指数**
   - 上证指数收盘价及涨跌幅
   - 深证指数收盘价及涨跌幅

2. **资金流向**
   - 主力资金净流入（超大单 + 大单）
   - 超大单净流入
   - 大单净流入
   - 中单净流入
   - 小单净流入

## 已完成的工作

### 1. 数据库表结构

已创建 `market_moneyflow` 表，字段包括：
- `trade_date`: 交易日期
- `close_sh`: 上证指数收盘点位
- `pct_change_sh`: 上证指数涨跌幅
- `close_sz`: 深证指数收盘点位
- `pct_change_sz`: 深证指数涨跌幅
- `net_amount`: 主力资金净流入金额
- `buy_elg_amount`: 超大单净流入金额
- `buy_lg_amount`: 大单净流入金额
- `buy_md_amount`: 中单净流入金额
- `buy_sm_amount`: 小单净流入金额
- 以及对应的净流入占比字段

### 2. Tushare 客户端接口

在 `data-service/src/data_sources/tushare_client.py` 中新增：
```python
async def get_market_moneyflow(
    start_date: str = None,
    end_date: str = None,
    trade_date: str = None
) -> Optional[pd.DataFrame]
```

### 3. 数据采集脚本

创建了 `download_market_moneyflow.py` 脚本，用于批量下载大盘资金流向数据。

**使用方法**：
```bash
# 下载最近 30 天的大盘资金流向数据
python download_market_moneyflow.py
```

**脚本特点**：
- 自动获取最近 30 天的数据
- 支持数据更新（INSERT OR REPLACE）
- 详细的进度日志

### 4. 后端 API 接口

在 `backend/src/routes/analysis.ts` 中新增：

**接口**: `GET /api/analysis/market-moneyflow`

**参数**:
- `days`: 查询最近天数（默认 30）
- `date_from`: 开始日期（YYYY-MM-DD）
- `date_to`: 结束日期（YYYY-MM-DD）

**返回数据**:
```json
{
  "success": true,
  "data": {
    "marketFlow": [...],
    "summary": {
      "totalNetAmount": 主力资金总净流入,
      "totalElgAmount": 超大单总净流入,
      "totalLgAmount": 大单总净流入,
      "totalMdAmount": 中单总净流入,
      "totalSmAmount": 小单总净流入,
      "avgNetAmountRate": 平均净流入占比,
      "latestSHIndex": 最新上证指数,
      "latestSZIndex": 最新深证指数,
      "latestSHChange": 最新上证涨跌幅,
      "latestSZChange": 最新深证涨跌幅
    }
  }
}
```

### 5. 前端资金流向卡片

已更新 `frontend/src/components/Analysis/FundFlowCard.tsx`：
- 使用大盘资金流向数据替代原来的个股汇总
- 显示四种资金类型：超大单、大单、中单、小单
- 保留日期筛选功能

**新的显示内容**：
```
资金流向分析
┌─────────────────────────────────────┐
│ 超大单          +232.4亿             │
│ ████████████████████████████████    │
│ 大单            -73.9亿              │
│ ████████                            │
│ 中单            -52.3亿              │
│ █████                               │
│ 小单            -106.2亿             │
│ ███████████                         │
└─────────────────────────────────────┘
```

## 使用流程

### 初始设置

1. **确保 Tushare Token 已配置**
   ```bash
   # 在 data-service/.env 文件中
   TUSHARE_TOKEN=your_tushare_token
   ```

2. **初始化数据库表**
   ```bash
   # 启动后端服务会自动创建表
   cd backend && npm run dev
   ```

3. **下载初始数据**
   ```bash
   # 下载最近 30 天的大盘资金流向数据
   python download_market_moneyflow.py
   ```

### 日常使用

1. **启动所有服务**
   ```bash
   # 方式一：并行启动（推荐）
   npm run dev

   # 方式二：分别启动
   cd frontend && npm run dev  # 前端 http://localhost:3001
   cd backend && npm run dev   # 后端 http://localhost:3000
   ```

2. **访问资金分析页面**
   - 打开浏览器访问: http://localhost:3001/analysis
   - 查看"资金流向分析"卡片

3. **使用日期筛选**
   - 点击卡片右上角的日期选择器
   - 选择起始日期和结束日期
   - 数据会自动刷新

### 定期数据更新

建议每天收盘后（15:30 之后）更新一次数据：

```bash
# 更新大盘资金流向数据
python download_market_moneyflow.py
```

**自动化（可选）**：

**Windows 任务计划程序**：
```batch
# 每日 16:00 自动更新
schtasks /create /tn "大盘资金流向更新" /tr "python E:\stock_an\stock-picker\download_market_moneyflow.py" /sc daily /st 16:00
```

**Linux/Mac crontab**：
```bash
# 每日 16:00 自动更新
0 16 * * 1-5 cd /path/to/stock-picker && python download_market_moneyflow.py
```

## API 使用示例

### 查询最近 7 天数据
```bash
curl "http://localhost:3000/api/analysis/market-moneyflow?days=7"
```

### 查询指定日期范围
```bash
curl "http://localhost:3000/api/analysis/market-moneyflow?date_from=2025-10-01&date_to=2025-10-24"
```

## 数据验证

验证数据是否正确下载：

```bash
# 查看最近 5 条记录
sqlite3 data/stock_picker.db "SELECT trade_date, close_sh, net_amount/100000000 as net_yi FROM market_moneyflow ORDER BY trade_date DESC LIMIT 5;"
```

**预期输出**：
```
2025-10-24|3950.31|158.43
2025-10-23|3922.41|-393.14
2025-10-22|3913.76|-510.70
2025-10-21|3916.33|264.48
2025-10-20|3863.89|-125.35
```

## 注意事项

1. **Tushare 权限要求**
   - 该接口需要 120 积分（试用）或 5000 积分（正式）
   - 单次最多返回 3000 条记录
   - 建议使用日期范围分批获取历史数据

2. **数据更新时间**
   - 数据在每日收盘后更新
   - 建议在 15:30 之后运行采集脚本

3. **数据完整性**
   - 非交易日不会有数据
   - 脚本会自动跳过无数据的日期

4. **与原资金流向的区别**
   - 原 `fund_flow` 表：存储个股资金流向
   - 新 `market_moneyflow` 表：存储市场整体资金流向
   - 两者互不影响，可以同时使用

## 后续优化建议

1. **增加更多统计维度**
   - 添加连续净流入天数统计
   - 添加资金流向强度指标
   - 添加与指数涨跌的相关性分析

2. **数据可视化增强**
   - 添加资金流向趋势图表
   - 添加不同资金类型的占比饼图
   - 添加与指数走势的对比图

3. **智能分析功能**
   - 基于资金流向的买卖点提示
   - 异常资金流向预警
   - 资金流向与市场情绪的关联分析

## 故障排查

### 问题 1: 数据采集失败

**症状**: 运行脚本提示"未获取到数据"

**解决方法**:
1. 检查 Tushare Token 是否正确配置
2. 检查积分是否足够（需要 120+）
3. 检查网络连接
4. 查看 Tushare 接口是否可用

### 问题 2: 前端显示为空

**症状**: 资金流向卡片显示"暂无数据"

**解决方法**:
1. 确认已运行数据采集脚本
2. 检查数据库中是否有数据
   ```bash
   sqlite3 data/stock_picker.db "SELECT COUNT(*) FROM market_moneyflow;"
   ```
3. 检查后端服务是否正常启动
4. 查看浏览器控制台是否有错误

### 问题 3: API 返回错误

**症状**: 浏览器控制台显示 API 错误

**解决方法**:
1. 检查后端服务是否运行在 3000 端口
2. 检查数据库文件是否存在
3. 查看后端日志输出

## 技术栈

- **后端**: Node.js + Express + TypeScript + SQLite
- **前端**: React + TypeScript + Ant Design
- **数据源**: Tushare Pro API（东财资金流向接口）
- **数据采集**: Python + pandas

## 文件清单

### 新增文件
- `download_market_moneyflow.py` - 数据采集脚本
- `大盘资金流向使用说明.md` - 本文档

### 修改文件
- `backend/src/config/database.ts` - 添加 market_moneyflow 表
- `backend/src/routes/analysis.ts` - 添加 market-moneyflow API
- `data-service/src/data_sources/tushare_client.py` - 添加 get_market_moneyflow 方法
- `frontend/src/services/analysisService.ts` - 添加 fetchMarketMoneyflowData 方法
- `frontend/src/hooks/useFundFlow.ts` - 使用大盘资金流向数据
- `frontend/src/components/Analysis/FundFlowCard.tsx` - 保留不变（已支持日期筛选）

---

**文档版本**: 1.0
**创建日期**: 2025-10-27
**最后更新**: 2025-10-27
