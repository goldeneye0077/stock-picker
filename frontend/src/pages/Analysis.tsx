import React, { useState, useEffect } from 'react';
import { Card, Row, Col, Progress, List, Avatar, message, Table, Tag, Statistic, Space, Typography, Select, Input, Button, DatePicker, Tooltip } from 'antd';
import { FundOutlined, RiseOutlined, FallOutlined, TrophyOutlined, FireOutlined, StarOutlined, SearchOutlined, ReloadOutlined, InfoCircleOutlined, SyncOutlined } from '@ant-design/icons';
import { API_BASE_URL, API_ENDPOINTS } from '../config/api';
import dayjs from 'dayjs';

const { Text, Title } = Typography;
const { Option } = Select;
const { RangePicker } = DatePicker;

const Analysis: React.FC = () => {
  const [fundFlowData, setFundFlowData] = useState([]);
  const [volumeAnalysis, setVolumeAnalysis] = useState([]);
  const [mainForceData, setMainForceData] = useState([]);
  const [mainForceSummary, setMainForceSummary] = useState<any>(null);
  const [loading, setLoading] = useState(false);

  // Á≠õÈÄâÊù°‰ª∂Áä∂ÊÄÅ
  const [filters, setFilters] = useState({
    board: '',      // ÊùøÂùó: main/gem/star/bse
    exchange: '',   // ‰∫§ÊòìÊâÄ: SSE/SZSE/BSE
    stockSearch: '', // ËÇ°Á•®‰ª£Á†ÅÊàñÂêçÁß∞ÊêúÁ¥¢
    dateFrom: '',   // ÂºÄÂßãÊó•Êúü
    dateTo: ''      // ÁªìÊùüÊó•Êúü
  });

  // ‰∏ªÂäõË°å‰∏∫ÂàÜÊûêÁ≠õÈÄâÊù°‰ª∂
  const [mainForceFilters, setMainForceFilters] = useState({
    days: 7,        // ÂàÜÊûêÂ§©Êï∞
    limit: 20,      // ÊòæÁ§∫Êï∞Èáè
    dateFrom: '',   // ÂºÄÂßãÊó•Êúü
    dateTo: ''      // ÁªìÊùüÊó•Êúü
  });

  // ËµÑÈáëÊµÅÂêëÂàÜÊûêÁ≠õÈÄâÊù°‰ª∂
  const [fundFlowFilters, setFundFlowFilters] = useState({
    days: 30,       // ÂàÜÊûêÂ§©Êï∞
    dateFrom: '',   // ÂºÄÂßãÊó•Êúü
    dateTo: ''      // ÁªìÊùüÊó•Êúü
  });

  // ÂçïÁã¨Âà∑Êñ∞ËµÑÈáëÊµÅÂêëÂàÜÊûêÊï∞ÊçÆ
  const fetchFundFlowData = async () => {
    setLoading(true);
    try {
      const fundFlowParams = new URLSearchParams({
        days: String(fundFlowFilters.days)
      });
      if (fundFlowFilters.dateFrom) fundFlowParams.append('date_from', fundFlowFilters.dateFrom);
      if (fundFlowFilters.dateTo) fundFlowParams.append('date_to', fundFlowFilters.dateTo);

      const fundFlowResponse = await fetch(`${API_BASE_URL}${API_ENDPOINTS.ANALYSIS}/fund-flow?${fundFlowParams}`);
      const fundFlowResult = await fundFlowResponse.json();

      if (fundFlowResult.success && fundFlowResult.data.summary) {
        const summary = fundFlowResult.data.summary;
        const totalFlow = Math.abs(summary.totalMainFlow) + Math.abs(summary.totalRetailFlow) + Math.abs(summary.totalInstitutionalFlow);

        setFundFlowData([
          {
            type: '‰∏ªÂäõËµÑÈáë',
            amount: `${summary.totalMainFlow >= 0 ? '+' : ''}${(summary.totalMainFlow / 100000000).toFixed(1)}‰∫ø`,
            percent: totalFlow > 0 ? Math.abs(summary.totalMainFlow) / totalFlow * 100 : 0,
            color: '#f50'
          },
          {
            type: 'Êú∫ÊûÑËµÑÈáë',
            amount: `${summary.totalInstitutionalFlow >= 0 ? '+' : ''}${(summary.totalInstitutionalFlow / 100000000).toFixed(1)}‰∫ø`,
            percent: totalFlow > 0 ? Math.abs(summary.totalInstitutionalFlow) / totalFlow * 100 : 0,
            color: '#2db7f5'
          },
          {
            type: 'Êï£Êà∑ËµÑÈáë',
            amount: `${summary.totalRetailFlow >= 0 ? '+' : ''}${(summary.totalRetailFlow / 100000000).toFixed(1)}‰∫ø`,
            percent: totalFlow > 0 ? Math.abs(summary.totalRetailFlow) / totalFlow * 100 : 0,
            color: '#87d068'
          }
        ]);
        message.success('ËµÑÈáëÊµÅÂêëÊï∞ÊçÆÂ∑≤Âà∑Êñ∞');
      } else {
        setFundFlowData([]);
        message.info('ÊöÇÊó†ËµÑÈáëÊµÅÂêëÊï∞ÊçÆ');
      }
    } catch (error) {
      console.error('Error fetching fund flow data:', error);
      message.error('Âà∑Êñ∞ËµÑÈáëÊµÅÂêëÊï∞ÊçÆÂ§±Ë¥•');
    } finally {
      setLoading(false);
    }
  };

  // ÂçïÁã¨Âà∑Êñ∞Êàê‰∫§ÈáèÂºÇÂä®ÂàÜÊûêÊï∞ÊçÆ
  const fetchVolumeAnalysisData = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams({ days: '10' });
      if (filters.board) params.append('board', filters.board);
      if (filters.exchange) params.append('exchange', filters.exchange);
      if (filters.stockSearch) params.append('stock_search', filters.stockSearch);
      if (filters.dateFrom) params.append('date_from', filters.dateFrom);
      if (filters.dateTo) params.append('date_to', filters.dateTo);

      const volumeResponse = await fetch(`${API_BASE_URL}${API_ENDPOINTS.ANALYSIS}/volume?${params}`);
      const volumeResult = await volumeResponse.json();

      if (volumeResult.success && volumeResult.data.volumeSurges) {
        const volumeData = volumeResult.data.volumeSurges.map((item: any) => ({
          stock: item.stock_code,
          name: item.stock_name || 'Êú™Áü•ËÇ°Á•®',
          exchange: item.exchange || '',
          volumeRatio: item.volume_ratio,
          trend: item.volume_ratio > 2 ? 'up' : 'down'
        }));
        setVolumeAnalysis(volumeData);
        message.success('Êàê‰∫§ÈáèÂºÇÂä®Êï∞ÊçÆÂ∑≤Âà∑Êñ∞');
      } else {
        setVolumeAnalysis([]);
        message.info('ÊöÇÊó†Êàê‰∫§ÈáèÂºÇÂä®Êï∞ÊçÆ');
      }
    } catch (error) {
      console.error('Error fetching volume analysis data:', error);
      message.error('Âà∑Êñ∞Êàê‰∫§ÈáèÂºÇÂä®Êï∞ÊçÆÂ§±Ë¥•');
    } finally {
      setLoading(false);
    }
  };

  // ÂçïÁã¨Âà∑Êñ∞‰∏ªÂäõË°å‰∏∫ÂàÜÊûêÊï∞ÊçÆ
  const fetchMainForceData = async () => {
    setLoading(true);
    try {
      const mainForceParams = new URLSearchParams({
        days: String(mainForceFilters.days),
        limit: String(mainForceFilters.limit)
      });
      if (mainForceFilters.dateFrom) mainForceParams.append('date_from', mainForceFilters.dateFrom);
      if (mainForceFilters.dateTo) mainForceParams.append('date_to', mainForceFilters.dateTo);

      const mainForceResponse = await fetch(`${API_BASE_URL}${API_ENDPOINTS.ANALYSIS}/main-force?${mainForceParams}`);
      const mainForceResult = await mainForceResponse.json();

      if (mainForceResult.success && mainForceResult.data.mainForce) {
        const mainForceDataWithKey = mainForceResult.data.mainForce.map((item: any, index: number) => ({
          key: String(index + 1),
          ...item
        }));
        setMainForceData(mainForceDataWithKey);
        setMainForceSummary(mainForceResult.data.summary);
        message.success('‰∏ªÂäõË°å‰∏∫Êï∞ÊçÆÂ∑≤Âà∑Êñ∞');
      } else {
        setMainForceData([]);
        setMainForceSummary(null);
        message.info('ÊöÇÊó†‰∏ªÂäõË°å‰∏∫Êï∞ÊçÆ');
      }
    } catch (error) {
      console.error('Error fetching main force data:', error);
      message.error('Âà∑Êñ∞‰∏ªÂäõË°å‰∏∫Êï∞ÊçÆÂ§±Ë¥•');
    } finally {
      setLoading(false);
    }
  };

  const fetchAnalysisData = async () => {
    setLoading(true);
    try {
      // Fetch fund flow data with filters
      const fundFlowParams = new URLSearchParams({
        days: String(fundFlowFilters.days)
      });
      if (fundFlowFilters.dateFrom) fundFlowParams.append('date_from', fundFlowFilters.dateFrom);
      if (fundFlowFilters.dateTo) fundFlowParams.append('date_to', fundFlowFilters.dateTo);

      const fundFlowResponse = await fetch(`${API_BASE_URL}${API_ENDPOINTS.ANALYSIS}/fund-flow?${fundFlowParams}`);
      const fundFlowResult = await fundFlowResponse.json();

      if (fundFlowResult.success && fundFlowResult.data.summary) {
        const summary = fundFlowResult.data.summary;
        const totalFlow = Math.abs(summary.totalMainFlow) + Math.abs(summary.totalRetailFlow) + Math.abs(summary.totalInstitutionalFlow);

        setFundFlowData([
          {
            type: '‰∏ªÂäõËµÑÈáë',
            amount: `${summary.totalMainFlow >= 0 ? '+' : ''}${(summary.totalMainFlow / 100000000).toFixed(1)}‰∫ø`,
            percent: totalFlow > 0 ? Math.abs(summary.totalMainFlow) / totalFlow * 100 : 0,
            color: '#f50'
          },
          {
            type: 'Êú∫ÊûÑËµÑÈáë',
            amount: `${summary.totalInstitutionalFlow >= 0 ? '+' : ''}${(summary.totalInstitutionalFlow / 100000000).toFixed(1)}‰∫ø`,
            percent: totalFlow > 0 ? Math.abs(summary.totalInstitutionalFlow) / totalFlow * 100 : 0,
            color: '#2db7f5'
          },
          {
            type: 'Êï£Êà∑ËµÑÈáë',
            amount: `${summary.totalRetailFlow >= 0 ? '+' : ''}${(summary.totalRetailFlow / 100000000).toFixed(1)}‰∫ø`,
            percent: totalFlow > 0 ? Math.abs(summary.totalRetailFlow) / totalFlow * 100 : 0,
            color: '#87d068'
          }
        ]);
      }

      // Fetch volume analysis data with filters
      const params = new URLSearchParams({ days: '10' });
      if (filters.board) params.append('board', filters.board);
      if (filters.exchange) params.append('exchange', filters.exchange);
      if (filters.stockSearch) params.append('stock_search', filters.stockSearch);
      if (filters.dateFrom) params.append('date_from', filters.dateFrom);
      if (filters.dateTo) params.append('date_to', filters.dateTo);

      const volumeResponse = await fetch(`${API_BASE_URL}${API_ENDPOINTS.ANALYSIS}/volume?${params}`);
      const volumeResult = await volumeResponse.json();

      console.log('üìä Volume API Response:', volumeResult);
      console.log('üìä Volume Surges:', volumeResult.data?.volumeSurges);

      if (volumeResult.success && volumeResult.data.volumeSurges) {
        const volumeData = volumeResult.data.volumeSurges.map((item: any) => ({
          stock: item.stock_code,
          name: item.stock_name || 'Êú™Áü•ËÇ°Á•®',
          exchange: item.exchange || '',
          volumeRatio: item.volume_ratio,
          trend: item.volume_ratio > 2 ? 'up' : 'down'
        }));
        console.log('üìä Processed Volume Data:', volumeData);
        setVolumeAnalysis(volumeData);
      } else {
        console.warn('‚ö†Ô∏è No volume surge data found:', volumeResult);
        setVolumeAnalysis([]);
      }

      // Fetch main force behavior analysis
      const mainForceParams = new URLSearchParams({
        days: String(mainForceFilters.days),
        limit: String(mainForceFilters.limit)
      });
      if (mainForceFilters.dateFrom) mainForceParams.append('date_from', mainForceFilters.dateFrom);
      if (mainForceFilters.dateTo) mainForceParams.append('date_to', mainForceFilters.dateTo);

      const mainForceResponse = await fetch(`${API_BASE_URL}${API_ENDPOINTS.ANALYSIS}/main-force?${mainForceParams}`);
      const mainForceResult = await mainForceResponse.json();

      if (mainForceResult.success && mainForceResult.data.mainForce) {
        const mainForceDataWithKey = mainForceResult.data.mainForce.map((item: any, index: number) => ({
          key: String(index + 1),
          ...item
        }));
        setMainForceData(mainForceDataWithKey);
        setMainForceSummary(mainForceResult.data.summary);
      } else {
        setMainForceData([]);
        setMainForceSummary(null);
      }

    } catch (error) {
      console.error('Error fetching analysis data:', error);
      message.error('Ëé∑ÂèñÂàÜÊûêÊï∞ÊçÆÂ§±Ë¥•');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchAnalysisData();
  }, [filters, mainForceFilters, fundFlowFilters]); // ÂΩìÁ≠õÈÄâÊù°‰ª∂ÂèòÂåñÊó∂ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ

  // ÈáçÁΩÆÁ≠õÈÄâÊù°‰ª∂
  const handleResetFilters = () => {
    setFilters({
      board: '',
      exchange: '',
      stockSearch: '',
      dateFrom: '',
      dateTo: ''
    });
  };

  // Â§ÑÁêÜÊó•ÊúüËåÉÂõ¥ÂèòÂåñ
  const handleDateRangeChange = (dates: any) => {
    if (dates && dates.length === 2) {
      setFilters({
        ...filters,
        dateFrom: dates[0].format('YYYY-MM-DD'),
        dateTo: dates[1].format('YYYY-MM-DD')
      });
    } else {
      setFilters({
        ...filters,
        dateFrom: '',
        dateTo: ''
      });
    }
  };

  return (
    <div style={{ padding: '24px' }}>
      <Row gutter={[16, 16]}>
        <Col span={10}>
          <Card
            title="ËµÑÈáëÊµÅÂêëÂàÜÊûê"
            extra={
              <Space size="small" wrap>
                <RangePicker
                  size="small"
                  style={{ width: 200 }}
                  placeholder={['ÂºÄÂßãÊó•Êúü', 'ÁªìÊùüÊó•Êúü']}
                  value={fundFlowFilters.dateFrom && fundFlowFilters.dateTo ? [dayjs(fundFlowFilters.dateFrom), dayjs(fundFlowFilters.dateTo)] : null}
                  onChange={(dates) => {
                    if (dates && dates.length === 2) {
                      setFundFlowFilters({
                        ...fundFlowFilters,
                        dateFrom: dates[0].format('YYYY-MM-DD'),
                        dateTo: dates[1].format('YYYY-MM-DD')
                      });
                    } else {
                      setFundFlowFilters({
                        ...fundFlowFilters,
                        dateFrom: '',
                        dateTo: ''
                      });
                    }
                  }}
                  format="YYYY-MM-DD"
                />
                <Select
                  value={fundFlowFilters.days}
                  onChange={(value) => setFundFlowFilters({ ...fundFlowFilters, days: value, dateFrom: '', dateTo: '' })}
                  style={{ width: 100 }}
                  size="small"
                  disabled={!!(fundFlowFilters.dateFrom && fundFlowFilters.dateTo)}
                >
                  <Option value={7}>ÊúÄËøë7Â§©</Option>
                  <Option value={15}>ÊúÄËøë15Â§©</Option>
                  <Option value={30}>ÊúÄËøë30Â§©</Option>
                  <Option value={60}>ÊúÄËøë60Â§©</Option>
                </Select>
                <Button
                  size="small"
                  type="primary"
                  icon={<SyncOutlined spin={loading} />}
                  onClick={fetchFundFlowData}
                  loading={loading}
                >
                  Âà∑Êñ∞Êï∞ÊçÆ
                </Button>
                <Button
                  size="small"
                  icon={<ReloadOutlined />}
                  onClick={() => setFundFlowFilters({ days: 30, dateFrom: '', dateTo: '' })}
                >
                  ÈáçÁΩÆ
                </Button>
              </Space>
            }
            loading={loading}
            style={{ height: '600px' }}
          >
            <div style={{ height: '530px', overflowY: 'auto', overflowX: 'hidden' }}>
              {fundFlowData.map((item: any, index) => (
              <div key={index} style={{ marginBottom: '16px' }}>
                <div style={{
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                  marginBottom: '8px',
                  flexWrap: 'nowrap'
                }}>
                  <span style={{ minWidth: '80px', fontSize: '14px' }}>{item.type}</span>
                  <span style={{
                    color: item.amount.startsWith('+') ? '#3f8600' : '#cf1322',
                    fontWeight: 'bold',
                    fontSize: '14px',
                    marginLeft: '8px'
                  }}>
                    {item.amount}
                  </span>
                </div>
                <Progress
                  percent={item.percent}
                  strokeColor={item.color}
                  showInfo={false}
                />
              </div>
            ))}
              {fundFlowData.length === 0 && !loading && (
                <div style={{ textAlign: 'center', color: '#999', padding: '20px' }}>
                  ÊöÇÊó†ËµÑÈáëÊµÅÂêëÊï∞ÊçÆ
                </div>
              )}
            </div>
          </Card>
        </Col>

        <Col span={14}>
          <Card
            title={
              <Space>
                Êàê‰∫§ÈáèÂºÇÂä®ÂàÜÊûê
                <Tooltip
                  title={
                    <div style={{ fontSize: '12px' }}>
                      <div style={{ marginBottom: '8px', fontWeight: 'bold' }}>üìä ÁÆóÊ≥ïËØ¥Êòé</div>
                      <div>‚Ä¢ ÈáèÊØî = ÂΩìÊó•Êàê‰∫§Èáè √∑ 20Êó•Âπ≥ÂùáÊàê‰∫§Èáè</div>
                      <div>‚Ä¢ Á≠õÈÄâÊ†áÂáÜ: ÈáèÊØî &gt; 2.0ÂÄç</div>
                      <div>‚Ä¢ ÂÖ≥Ê≥®Êàê‰∫§ÈáèÁöÑÊîæÂ§ßÁ®ãÂ∫¶</div>
                      <div style={{ marginTop: '8px', color: '#faad14' }}>‚ö†Ô∏è ‰æßÈáç‰∫éËØÜÂà´ÊòéÊòæÁöÑÊîæÈáèÂºÇÂä®</div>
                    </div>
                  }
                  placement="right"
                >
                  <InfoCircleOutlined style={{ color: '#1890ff', cursor: 'pointer' }} />
                </Tooltip>
              </Space>
            }
            loading={loading}
            style={{ height: '600px' }}
            extra={
              <Space size="small">
                <Button
                  size="small"
                  type="primary"
                  icon={<SyncOutlined spin={loading} />}
                  onClick={fetchVolumeAnalysisData}
                  loading={loading}
                >
                  Âà∑Êñ∞Êï∞ÊçÆ
                </Button>
                <Button
                  size="small"
                  icon={<ReloadOutlined />}
                  onClick={handleResetFilters}
                >
                  ÈáçÁΩÆ
                </Button>
              </Space>
            }
          >
            {/* Á≠õÈÄâÊù°‰ª∂ */}
            <div style={{ marginBottom: '16px', padding: '12px', backgroundColor: '#1f1f1f', borderRadius: '6px' }}>
              <Space wrap size="small">
                <Select
                  placeholder="ÊùøÂùó"
                  allowClear
                  value={filters.board || undefined}
                  onChange={(value) => setFilters({ ...filters, board: value || '' })}
                  style={{ width: 120 }}
                  size="small"
                >
                  <Option value="main">‰∏ªÊùø</Option>
                  <Option value="gem">Âàõ‰∏öÊùø</Option>
                  <Option value="star">ÁßëÂàõÊùø</Option>
                  <Option value="bse">Âåó‰∫§ÊâÄ</Option>
                </Select>

                <Select
                  placeholder="‰∫§ÊòìÊâÄ"
                  allowClear
                  value={filters.exchange || undefined}
                  onChange={(value) => setFilters({ ...filters, exchange: value || '' })}
                  style={{ width: 120 }}
                  size="small"
                >
                  <Option value="SSE">‰∏ä‰∫§ÊâÄ</Option>
                  <Option value="SZSE">Ê∑±‰∫§ÊâÄ</Option>
                  <Option value="BSE">Âåó‰∫§ÊâÄ</Option>
                </Select>

                <Input
                  placeholder="ËÇ°Á•®‰ª£Á†Å/ÂêçÁß∞"
                  allowClear
                  prefix={<SearchOutlined />}
                  value={filters.stockSearch}
                  onChange={(e) => setFilters({ ...filters, stockSearch: e.target.value })}
                  style={{ width: 150 }}
                  size="small"
                />

                <RangePicker
                  size="small"
                  style={{ width: 240 }}
                  placeholder={['ÂºÄÂßãÊó•Êúü', 'ÁªìÊùüÊó•Êúü']}
                  value={filters.dateFrom && filters.dateTo ? [dayjs(filters.dateFrom), dayjs(filters.dateTo)] : null}
                  onChange={handleDateRangeChange}
                  format="YYYY-MM-DD"
                />

                <Text type="secondary" style={{ fontSize: '12px' }}>
                  ÂÖ± {volumeAnalysis.length} Êù°
                </Text>
              </Space>
            </div>

            <div style={{ height: '420px', overflowY: 'auto', overflowX: 'hidden' }}>
              <List
                dataSource={volumeAnalysis}
                locale={{ emptyText: 'ÊöÇÊó†Êàê‰∫§ÈáèÂºÇÂä®Êï∞ÊçÆ' }}
                size="small"
                split={false}
                renderItem={(item: any) => (
                <List.Item style={{
                  padding: '12px 16px',
                  borderBottom: '1px solid #e8e8e8',
                  backgroundColor: '#001529',
                  marginBottom: '8px',
                  borderRadius: '6px',
                  border: '1px solid #434343'
                }}>
                  <List.Item.Meta
                    avatar={
                      <Avatar
                        icon={item.trend === 'up' ? <RiseOutlined /> : <FallOutlined />}
                        style={{
                          backgroundColor: item.trend === 'up' ? '#52c41a' : '#ff4d4f'
                        }}
                      />
                    }
                    title={
                      <div style={{
                        display: 'flex',
                        justifyContent: 'space-between',
                        alignItems: 'center',
                        flexWrap: 'nowrap',
                        minWidth: 0
                      }}>
                        <span style={{
                          fontWeight: '500',
                          fontSize: '14px',
                          color: '#ffffff',
                          flex: '1',
                          minWidth: 0,
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}>
                          {item.stock} {item.name}
                        </span>
                        <span style={{
                          color: item.trend === 'up' ? '#52c41a' : '#ff4d4f',
                          fontWeight: 'bold',
                          fontSize: '12px',
                          marginLeft: '12px',
                          flexShrink: 0
                        }}>
                          {item.trend === 'up' ? 'ÊîæÈáè‰∏äÊ∂®' : 'Áº©Èáè‰∏ãË∑å'}
                        </span>
                      </div>
                    }
                    description={
                      <div style={{
                        fontSize: '12px',
                        color: '#ffffff',
                        display: 'flex',
                        alignItems: 'center',
                        flexWrap: 'nowrap'
                      }}>
                        <span>ÈáèÊØî: </span>
                        <span style={{ fontWeight: 'bold', color: '#40a9ff', marginRight: '8px' }}>
                          {item.volumeRatio?.toFixed(2) || 0}ÂÄç
                        </span>
                        {item.volumeRatio > 2 && (
                          <span style={{
                            color: '#ff7875',
                            fontWeight: 'bold',
                            fontSize: '11px',
                            flexShrink: 0
                          }}>
                            ÂºÇÂ∏∏ÊîæÈáè
                          </span>
                        )}
                      </div>
                    }
                  />
                </List.Item>
              )}
            />
            </div>
          </Card>
        </Col>
      </Row>

      <Row gutter={[16, 16]} style={{ marginTop: '24px' }}>
        <Col span={24}>
          <Card
            title={
              <Space>
                <TrophyOutlined style={{ color: '#faad14' }} />
                ‰∏ªÂäõË°å‰∏∫ÂàÜÊûê
                <Tooltip
                  title={
                    <div style={{ fontSize: '12px' }}>
                      <div style={{ marginBottom: '8px', fontWeight: 'bold' }}>üí∞ ÁÆóÊ≥ïËØ¥Êòé</div>
                      <div>‚Ä¢ Âü∫‰∫éÊúÄËøë7Â§©ÁöÑ‰∏ªÂäõËµÑÈáëÊµÅÂêëÊï∞ÊçÆ</div>
                      <div>‚Ä¢ ÂàÜÊûêÁª¥Â∫¶:</div>
                      <div style={{ marginLeft: '12px' }}>- ÊÄªËµÑÈáëÊµÅÂä® &gt; 500‰∏á</div>
                      <div style={{ marginLeft: '12px' }}>- ÊµÅÂÖ•Â§©Êï∞ÊØî‰æã (ÊåÅÁª≠ÊÄß)</div>
                      <div style={{ marginLeft: '12px' }}>- Â§ßÂçïÂç†ÊØî (ÂäõÂ∫¶)</div>
                      <div>‚Ä¢ Ë°å‰∏∫ÂàÜÁ±ª:</div>
                      <div style={{ marginLeft: '12px' }}>- Â§ßÂπÖÂª∫‰ªì: 70%+Â§©Êï∞ÊµÅÂÖ•</div>
                      <div style={{ marginLeft: '12px' }}>- ÊåÅÁª≠Âª∫‰ªì: 50%+Â§©Êï∞ÊµÅÂÖ•</div>
                      <div style={{ marginLeft: '12px' }}>- ÁºìÊÖ¢Âáè‰ªì: 30%-Â§©Êï∞ÊµÅÂÖ•</div>
                      <div style={{ marginTop: '8px', color: '#52c41a' }}>‚úÖ ËÉΩËØÜÂà´Ê∏©ÂíåÂê∏Á≠πÁöÑÈöêËîΩÊìç‰Ωú</div>
                    </div>
                  }
                  placement="left"
                >
                  <InfoCircleOutlined style={{ color: '#1890ff', cursor: 'pointer' }} />
                </Tooltip>
              </Space>
            }
            loading={loading}
            extra={
              <Space size="small" wrap>
                <RangePicker
                  size="small"
                  style={{ width: 240 }}
                  placeholder={['ÂºÄÂßãÊó•Êúü', 'ÁªìÊùüÊó•Êúü']}
                  value={mainForceFilters.dateFrom && mainForceFilters.dateTo ? [dayjs(mainForceFilters.dateFrom), dayjs(mainForceFilters.dateTo)] : null}
                  onChange={(dates) => {
                    if (dates && dates.length === 2) {
                      setMainForceFilters({
                        ...mainForceFilters,
                        dateFrom: dates[0].format('YYYY-MM-DD'),
                        dateTo: dates[1].format('YYYY-MM-DD')
                      });
                    } else {
                      setMainForceFilters({
                        ...mainForceFilters,
                        dateFrom: '',
                        dateTo: ''
                      });
                    }
                  }}
                  format="YYYY-MM-DD"
                />
                <Select
                  value={mainForceFilters.days}
                  onChange={(value) => setMainForceFilters({ ...mainForceFilters, days: value, dateFrom: '', dateTo: '' })}
                  style={{ width: 110 }}
                  size="small"
                  disabled={!!(mainForceFilters.dateFrom && mainForceFilters.dateTo)}
                >
                  <Option value={3}>ÊúÄËøë3Â§©</Option>
                  <Option value={5}>ÊúÄËøë5Â§©</Option>
                  <Option value={7}>ÊúÄËøë7Â§©</Option>
                  <Option value={10}>ÊúÄËøë10Â§©</Option>
                  <Option value={15}>ÊúÄËøë15Â§©</Option>
                  <Option value={30}>ÊúÄËøë30Â§©</Option>
                </Select>
                <Select
                  value={mainForceFilters.limit}
                  onChange={(value) => setMainForceFilters({ ...mainForceFilters, limit: value })}
                  style={{ width: 110 }}
                  size="small"
                >
                  <Option value={10}>ÊòæÁ§∫10Êù°</Option>
                  <Option value={20}>ÊòæÁ§∫20Êù°</Option>
                  <Option value={50}>ÊòæÁ§∫50Êù°</Option>
                  <Option value={100}>ÊòæÁ§∫100Êù°</Option>
                </Select>
                <Button
                  size="small"
                  type="primary"
                  icon={<SyncOutlined spin={loading} />}
                  onClick={fetchMainForceData}
                  loading={loading}
                >
                  Âà∑Êñ∞Êï∞ÊçÆ
                </Button>
                <Button
                  size="small"
                  icon={<ReloadOutlined />}
                  onClick={() => setMainForceFilters({ days: 7, limit: 20, dateFrom: '', dateTo: '' })}
                >
                  ÈáçÁΩÆ
                </Button>
              </Space>
            }
          >
            {mainForceData.length > 0 ? (
              <div>
                {/* ÁªüËÆ°Ê¶ÇËßà */}
                <Row gutter={16} style={{ marginBottom: '24px' }}>
                  <Col span={6}>
                    <Card size="small" style={{ textAlign: 'center' }}>
                      <Statistic
                        title="Âº∫ÂäøÂª∫‰ªì"
                        value={mainForceData.filter(item => item.trend === 'strong').length}
                        prefix={<FireOutlined style={{ color: '#ff4d4f' }} />}
                        valueStyle={{ color: '#ff4d4f' }}
                        suffix="Âè™"
                      />
                    </Card>
                  </Col>
                  <Col span={6}>
                    <Card size="small" style={{ textAlign: 'center' }}>
                      <Statistic
                        title="Á®≥ÂÆöÊìç‰Ωú"
                        value={mainForceData.filter(item => item.trend === 'moderate').length}
                        prefix={<StarOutlined style={{ color: '#1890ff' }} />}
                        valueStyle={{ color: '#1890ff' }}
                        suffix="Âè™"
                      />
                    </Card>
                  </Col>
                  <Col span={6}>
                    <Card size="small" style={{ textAlign: 'center' }}>
                      <Statistic
                        title="Âπ≥ÂùáÂº∫Â∫¶"
                        value={Math.round(mainForceData.reduce((sum, item) => sum + item.strength, 0) / mainForceData.length)}
                        prefix={<TrophyOutlined style={{ color: '#52c41a' }} />}
                        valueStyle={{ color: '#52c41a' }}
                        suffix="%"
                      />
                    </Card>
                  </Col>
                  <Col span={6}>
                    <Card size="small" style={{ textAlign: 'center' }}>
                      <Statistic
                        title="ÊÄªÊàê‰∫§Èáè"
                        value={mainForceSummary?.totalVolume || '0'}
                        prefix={<RiseOutlined style={{ color: '#faad14' }} />}
                        valueStyle={{ color: '#faad14' }}
                        suffix="‰∫ø"
                      />
                    </Card>
                  </Col>
                </Row>

                {/* ‰∏ªÂäõË°å‰∏∫Ë°®Ê†º */}
                <Table
                  dataSource={mainForceData}
                  pagination={false}
                  size="small"
                  scroll={{ y: 200 }}
                  columns={[
                    {
                      title: 'ËÇ°Á•®',
                      dataIndex: 'stock',
                      key: 'stock',
                      width: 80,
                      render: (text, record) => (
                        <div>
                          <div style={{ fontWeight: 'bold' }}>{text}</div>
                          <div style={{ fontSize: '12px', color: '#666' }}>{record.name}</div>
                        </div>
                      )
                    },
                    {
                      title: '‰∏ªÂäõË°å‰∏∫',
                      dataIndex: 'behavior',
                      key: 'behavior',
                      width: 100,
                      render: (text, record) => {
                        const colors = {
                          strong: '#ff4d4f',
                          moderate: '#1890ff',
                          weak: '#666'
                        };
                        return (
                          <Tag color={colors[record.trend] || '#666'}>
                            {text}
                          </Tag>
                        );
                      }
                    },
                    {
                      title: 'Âº∫Â∫¶ÊåáÊï∞',
                      dataIndex: 'strength',
                      key: 'strength',
                      width: 120,
                      render: (strength) => (
                        <div>
                          <Progress
                            percent={strength}
                            size="small"
                            strokeColor={
                              strength >= 80 ? '#ff4d4f' :
                              strength >= 60 ? '#faad14' : '#52c41a'
                            }
                            format={() => `${strength}%`}
                          />
                        </div>
                      )
                    },
                    {
                      title: 'Êàê‰∫§Èáè',
                      dataIndex: 'volume',
                      key: 'volume',
                      width: 80,
                      render: (volume) => (
                        <Text strong style={{ color: '#1890ff' }}>{volume}</Text>
                      )
                    },
                    {
                      title: 'ÊåÅÁª≠Â§©Êï∞',
                      dataIndex: 'days',
                      key: 'days',
                      width: 80,
                      render: (days) => (
                        <Tag color="blue">{days}Â§©</Tag>
                      )
                    },
                    {
                      title: 'Êìç‰ΩúÂª∫ËÆÆ',
                      key: 'advice',
                      width: 100,
                      render: (_, record) => {
                        let advice = '';
                        let color = '';
                        if (record.strength >= 80 && record.trend === 'strong') {
                          advice = 'ÈáçÁÇπÂÖ≥Ê≥®';
                          color = '#ff4d4f';
                        } else if (record.strength >= 60) {
                          advice = 'ÈÄÇÂ∫¶ÂÖ≥Ê≥®';
                          color = '#faad14';
                        } else {
                          advice = 'Ë∞®ÊÖéËßÇÂØü';
                          color = '#666';
                        }
                        return <Tag color={color}>{advice}</Tag>;
                      }
                    }
                  ]}
                />
              </div>
            ) : (
              <div style={{
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                height: '200px',
                color: '#666'
              }}>
                <span>ÊöÇÊó†‰∏ªÂäõË°å‰∏∫ÂàÜÊûêÊï∞ÊçÆ</span>
              </div>
            )}
          </Card>
        </Col>
      </Row>
    </div>
  );
};

export default Analysis;