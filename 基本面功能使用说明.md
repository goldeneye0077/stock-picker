# 基本面功能使用说明

## 概述

基本面功能模块为智能选股系统提供了完整的财务数据分析能力，包括财务指标采集、财务报表分析、估值评估、分红分析、股东结构分析等核心功能。

## 功能架构

```
基本面功能模块
├── 数据采集层 (FundamentalClient)
│   ├── 股票基本信息采集
│   ├── 财务指标采集
│   ├── 财务报表采集（利润表、资产负债表、现金流量表）
│   ├── 分红数据采集
│   ├── 股东数据采集
│   └── 估值数据采集
├── 分析层 (FundamentalAnalyzer)
│   ├── 财务分析（盈利能力、偿债能力、运营效率）
│   ├── 估值分析（PE、PB、PS等）
│   ├── 分红分析
│   ├── 股东结构分析
│   ├── 行业地位分析
│   ├── 风险评估
│   └── 投资建议生成
├── 数据存储层 (FundamentalDB)
│   ├── 股票基本信息扩展表
│   ├── 财务指标表
│   ├── 财务报表表（利润表、资产负债表、现金流量表）
│   ├── 分红数据表
│   ├── 股东数据表
│   └── 基本面评分表
└── API接口层 (Fundamental API)
    ├── 数据采集API
    ├── 数据分析API
    ├── 数据查询API
    └── 批量处理API
```

## 快速开始

### 1. 环境准备

确保已安装所需依赖：

```bash
cd data-service
pip install -r requirements.txt
```

### 2. 配置Tushare Token

在 `data-service/.env` 文件中配置Tushare Token：

```
TUSHARE_TOKEN=your_tushare_pro_token
```

### 3. 启动数据服务

```bash
cd data-service
python -m uvicorn src.main:app --reload --port 8001
```

服务启动后访问：http://localhost:8001

## API接口说明

### 健康检查
```
GET /api/fundamental/health
```

### 股票基本信息
```
GET /api/fundamental/stock/{stock_code}/basic
```

### 财务指标数据
```
GET /api/fundamental/stock/{stock_code}/financial-indicators
GET /api/fundamental/stock/{stock_code}/financial-indicators?period=20241231
```

### 财务报表数据
```
GET /api/fundamental/stock/{stock_code}/financial-statements
GET /api/fundamental/stock/{stock_code}/financial-statements?period=20241231
```

### 分红数据
```
GET /api/fundamental/stock/{stock_code}/dividend
```

### 股东数据
```
GET /api/fundamental/stock/{stock_code}/shareholders
```

### 估值数据
```
GET /api/fundamental/stock/{stock_code}/valuation
```

### 综合基本面数据
```
GET /api/fundamental/stock/{stock_code}/comprehensive
```

### 获取并保存基本面数据
```
POST /api/fundamental/stock/{stock_code}/fetch-and-save
```

### 批量获取并保存
```
POST /api/fundamental/batch/fetch-and-save
Content-Type: application/json

{
  "stock_codes": ["000001.SZ", "000002.SZ", "000858.SZ"]
}
```

### 基本面分析
```
GET /api/fundamental/stock/{stock_code}/analysis
```

### 批量分析
```
POST /api/fundamental/batch/analyze
Content-Type: application/json

{
  "stock_codes": ["000001.SZ", "000002.SZ", "000858.SZ"]
}
```

### 获取高分股票
```
GET /api/fundamental/top-stocks?limit=20&min_score=70
```

### 股票比较
```
POST /api/fundamental/compare
Content-Type: application/json

{
  "stock_codes": ["000001.SZ", "000002.SZ", "000858.SZ"]
}
```

### 评分历史
```
GET /api/fundamental/stock/{stock_code}/scores?limit=10
```

### 最新财务报表
```
GET /api/fundamental/stock/{stock_code}/latest-financials
```

### 分红历史
```
GET /api/fundamental/stock/{stock_code}/dividend-history?limit=10
```

### 前十大股东
```
GET /api/fundamental/stock/{stock_code}/top-shareholders?limit=10
```

### 股票扩展信息
```
GET /api/fundamental/stock/{stock_code}/extended-info
```

## Python代码使用示例

### 1. 使用基本面客户端

```python
import asyncio
from data_sources.tushare_client import TushareClient
from analyzers.fundamental.fundamental_client import FundamentalClient

async def example_fundamental_client():
    # 初始化客户端
    tushare_client = TushareClient()
    fundamental_client = FundamentalClient(tushare_client)

    # 获取股票基本信息
    stock_code = "000001.SZ"
    basic_info = await fundamental_client.fetch_stock_basic_info(stock_code)
    print(f"股票名称: {basic_info.get('name')}")

    # 获取财务指标
    financial_indicators = await fundamental_client.fetch_financial_indicators(stock_code)
    print(f"ROE: {financial_indicators.get('roe')}")

    # 获取综合基本面数据
    comprehensive_data = await fundamental_client.fetch_comprehensive_fundamental_data(stock_code)
    print(f"基本面评分: {comprehensive_data.get('fundamental_score')}")

    # 保存数据到数据库
    await fundamental_client.save_fundamental_data_to_db(stock_code, comprehensive_data)

asyncio.run(example_fundamental_client())
```

### 2. 使用基本面分析器

```python
import asyncio
from data_sources.tushare_client import TushareClient
from analyzers.fundamental.fundamental_client import FundamentalClient
from analyzers.fundamental.fundamental_analyzer import FundamentalAnalyzer

async def example_fundamental_analyzer():
    # 初始化分析器
    tushare_client = TushareClient()
    fundamental_client = FundamentalClient(tushare_client)
    analyzer = FundamentalAnalyzer(fundamental_client)

    # 分析单只股票
    stock_code = "000001.SZ"
    analysis_result = await analyzer.analyze_stock_fundamentals(stock_code)

    print(f"综合评分: {analysis_result.get('overall_score')}")
    print(f"投资建议: {analysis_result['investment_recommendation']['rating']}")
    print(f"风险评估: {analysis_result['risk_assessment']['overall_risk_level']}")

    # 获取高分股票
    top_stocks = await analyzer.get_top_fundamental_stocks(limit=10, min_score=70)
    print(f"找到 {len(top_stocks)} 只高分股票")

    # 比较多只股票
    comparison = await analyzer.compare_stocks(["000001.SZ", "000002.SZ", "000858.SZ"])
    print(f"比较结果: {comparison}")

asyncio.run(example_fundamental_analyzer())
```

### 3. 使用基本面数据库

```python
import asyncio
from utils.fundamental_db import FundamentalDB

async def example_fundamental_db():
    db = FundamentalDB()

    # 获取基本面评分
    stock_code = "000001.SZ"
    score = await db.get_fundamental_score(stock_code)
    if score:
        print(f"基本面评分: {score.get('overall_score')}")

    # 获取财务指标历史
    indicators_history = await db.get_financial_indicators_history(stock_code, limit=5)
    print(f"财务指标历史记录数: {len(indicators_history)}")

    # 获取最新财务报表
    financials = await db.get_latest_financial_statements(stock_code)
    if financials:
        print("成功获取最新财务报表")

    # 获取高分股票
    top_stocks = await db.get_top_fundamental_stocks(limit=10, min_score=70)
    print(f"高分股票数量: {len(top_stocks)}")

asyncio.run(example_fundamental_db())
```

## 基本面评分体系

### 评分权重分配

| 评分维度 | 权重 | 说明 |
|---------|------|------|
| 盈利能力 | 25% | ROE、毛利率、净利率等 |
| 偿债能力 | 15% | 资产负债率、流动比率等 |
| 现金流质量 | 10% | 经营现金流、自由现金流等 |
| 估值水平 | 20% | PE、PB、PS等估值指标 |
| 分红情况 | 10% | 股息率、分红连续性等 |
| 股东结构 | 5% | 机构持股、股东集中度等 |
| 行业地位 | 10% | 市场地位、竞争优势等 |
| 成长性 | 3% | 收入增长、利润增长等 |
| 质量指标 | 2% | 财务质量综合评估 |

### 评分等级

| 评分范围 | 等级 | 投资建议 |
|---------|------|----------|
| 90-100 | 优秀 | 强烈买入 |
| 80-89 | 良好 | 买入 |
| 70-79 | 较好 | 增持 |
| 60-69 | 一般 | 持有 |
| 50-59 | 较差 | 减持 |
| 0-49 | 差 | 卖出 |

## 数据库表结构

### 1. stock_basic_extended (股票基本信息扩展表)
- 存储股票基本信息和公司信息
- 包含上市天数、董事长、总经理、注册资本等字段

### 2. financial_indicators (财务指标表)
- 存储财务指标数据
- 包含ROE、ROA、毛利率、净利率、资产负债率等

### 3. income_statements (利润表)
- 存储利润表数据
- 包含营业收入、营业成本、净利润、每股收益等

### 4. balance_sheets (资产负债表)
- 存储资产负债表数据
- 包含总资产、总负债、所有者权益等

### 5. cash_flow_statements (现金流量表)
- 存储现金流量表数据
- 包含经营现金流、投资现金流、筹资现金流等

### 6. dividend_data (分红数据表)
- 存储分红数据
- 包含分红金额、除权除息日、股权登记日等

### 7. shareholder_data (股东数据表)
- 存储股东数据
- 包含股东名称、持股数量、持股比例等

### 8. fundamental_scores (基本面评分表)
- 存储基本面评分结果
- 包含各项评分、综合评分、投资建议等

## 测试方法

### 1. 运行单元测试

```bash
cd data-service
python -m pytest tests/test_fundamental.py -v
```

### 2. 运行功能测试

```bash
python test_fundamental_api.py
```

### 3. API测试

启动服务后，使用curl或Postman测试API：

```bash
# 健康检查
curl http://localhost:8001/api/fundamental/health

# 获取股票基本信息
curl http://localhost:8001/api/fundamental/stock/000001.SZ/basic

# 基本面分析
curl http://localhost:8001/api/fundamental/stock/000001.SZ/analysis

# 获取高分股票
curl "http://localhost:8001/api/fundamental/top-stocks?limit=10&min_score=70"
```

## 注意事项

1. **API限频**: Tushare API有调用频率限制，批量处理时需添加适当延迟
2. **数据更新**: 财务数据按季度更新，需定期更新数据库
3. **权限要求**: 部分高级财务数据需要Tushare高级权限
4. **数据完整性**: 部分股票可能缺少某些财务数据，需做好异常处理
5. **评分算法**: 基本面评分算法可根据实际需求调整权重和评分标准

## 故障排除

### 常见问题

1. **Tushare Token无效**
   - 检查`.env`文件中的`TUSHARE_TOKEN`配置
   - 确认Token是否过期或权限不足

2. **数据库连接失败**
   - 检查数据库文件路径和权限
   - 确认数据库表结构已正确初始化

3. **API调用失败**
   - 检查网络连接
   - 确认Tushare服务状态
   - 查看日志获取详细错误信息

4. **数据缺失**
   - 部分股票可能没有某些财务数据
   - 新上市股票数据可能不完整
   - 退市股票数据可能已停止更新

### 日志查看

```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

或查看服务日志输出。

## 后续扩展

1. **增加更多财务指标**
   - 添加杜邦分析指标
   - 添加财务预警指标
   - 添加行业对比指标

2. **优化评分算法**
   - 引入机器学习模型
   - 添加动态权重调整
   - 考虑宏观经济因素

3. **增加数据可视化**
   - 财务报表可视化
   - 财务趋势图表
   - 行业对比图表

4. **集成更多数据源**
   - 添加Wind、Choice等数据源
   - 添加公司公告数据
   - 添加研报数据

5. **实时监控预警**
   - 财务指标异常预警
   - 重大事项提醒
   - 投资组合监控