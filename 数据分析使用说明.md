# 数据分析使用说明

## 问题背景

您发现仪表盘的大部分数据显示为 0（除了"今日监控股票"显示正常）。经过分析，这些 0 值是**真实的数据库查询结果**，而不是数据读取失败。

### 根本原因

数据采集和数据分析是**两个独立的步骤**：

1. **数据采集阶段**（已完成）
   - 运行 `download_7days_all_stocks.py`
   - 下载原始 K 线数据到 `klines` 表
   - 下载股票基本信息到 `stocks` 表
   - ✅ 状态：5419 条 K 线记录已采集

2. **数据分析阶段**（之前缺失）
   - 基于 K 线数据计算成交量分析 → 写入 `volume_analysis` 表
   - 综合评估生成买入信号 → 写入 `buy_signals` 表
   - ❌ 状态：这两个表为空，导致仪表盘显示 0

---

## 解决方案

已为您创建 3 个数据处理脚本：

### 1. `analyze_all_stocks.py` - 成交量分析

**功能**：
- 读取 `klines` 表的 K 线数据
- 计算 20 日平均成交量
- 计算量比（当日成交量/20 日均量）
- 标记异常放量股票（量比 > 2.0）
- 将分析结果写入 `volume_analysis` 表

**运行**：
```bash
cd stock-picker
python analyze_all_stocks.py
```

**预计耗时**：约 13 分钟（5419 只股票）

**输出示例**：
```
19:00:12 | 开始批量成交量分析...
19:00:12 | 找到 5419 只股票需要分析
19:00:25 | 进度: 100/5419 (1.8%) - 成功: 99, 失败: 0
19:00:39 | 进度: 200/5419 (3.7%) - 成功: 199, 失败: 0
...
19:13:45 | 批量分析完成！总计: 5419, 成功: 5395, 失败/跳过: 24
19:13:45 | 最近3天异常放量股票数: 127 只
```

### 2. `generate_buy_signals.py` - 买入信号生成

**功能**：
- 读取 `volume_analysis`、`klines`、`fund_flow` 表数据
- 计算三项评分：
  - 成交量评分（权重 40%）
  - 价格走势评分（权重 30%）
  - 资金流向评分（权重 30%）
- 生成综合信号（强烈买入/买入/关注/观察）
- 将有价值的信号（关注及以上）写入 `buy_signals` 表

**运行**：
```bash
cd stock-picker
python generate_buy_signals.py
```

**预计耗时**：约 2 分钟

**输出示例**：
```
19:15:20 | 开始生成买入信号...
19:15:20 | 找到 5395 只股票需要分析
19:15:23 |   600519 贵州茅台: 强烈买入 (置信度85.3%, 量比3.24)
19:15:23 |   000858 五粮液: 买入 (置信度72.1%, 量比2.87)
...
19:17:12 | 批量信号生成完成！
19:17:12 |   强烈买入: 23 只
19:17:12 |   买入: 145 只
19:17:12 |   关注: 389 只
19:17:12 | 今日新增信号: 557 条
```

### 3. `update_all_data.py` - 一键更新脚本（推荐）

**功能**：
自动按顺序执行以下 3 个步骤：
1. 采集数据（`download_7days_all_stocks.py`）
2. 分析成交量（`analyze_all_stocks.py`）
3. 生成买入信号（`generate_buy_signals.py`）

**运行**：
```bash
cd stock-picker
python update_all_data.py
```

**预计耗时**：约 17 分钟（2分钟采集 + 13分钟分析 + 2分钟信号生成）

**优势**：
- 全自动化，无需人工干预
- 步骤间有错误检测，失败会自动停止
- 适合每日数据更新

---

## 数据流程图

```
┌─────────────────────────┐
│  数据采集                │
│  download_7days_all_    │
│  stocks.py              │
└────────────┬────────────┘
             │
             ▼
    ┌────────────────┐
    │  stocks 表      │  股票基本信息
    │  klines 表      │  K线数据
    │  fund_flow 表   │  资金流向（需权限）
    └────────┬───────┘
             │
             ▼
┌─────────────────────────┐
│  成交量分析              │
│  analyze_all_stocks.py  │
└────────────┬────────────┘
             │
             ▼
    ┌────────────────────┐
    │  volume_analysis 表│  成交量分析结果
    └────────┬───────────┘
             │
             ▼
┌─────────────────────────┐
│  买入信号生成            │
│  generate_buy_signals.  │
│  py                     │
└────────────┬────────────┘
             │
             ▼
    ┌────────────────┐
    │  buy_signals 表│  买入信号
    └────────┬───────┘
             │
             ▼
    ┌────────────────┐
    │  前端仪表盘显示 │
    └────────────────┘
```

---

## 使用建议

### 首次使用

1. **运行成交量分析**（已在后台运行中）
   ```bash
   python analyze_all_stocks.py
   ```
   等待约 13 分钟完成

2. **生成买入信号**
   ```bash
   python generate_buy_signals.py
   ```
   等待约 2 分钟完成

3. **刷新前端页面**
   - 仪表盘数据应该正常显示
   - "异常成交量股票"、"今日新增信号" 等指标不再为 0

### 每日更新（推荐流程）

**方式 1：使用一键脚本**
```bash
cd stock-picker
python update_all_data.py
```

**方式 2：分步执行**
```bash
# 步骤1：采集数据
python download_7days_all_stocks.py

# 步骤2：分析数据
python analyze_all_stocks.py

# 步骤3：生成信号
python generate_buy_signals.py
```

### 定时任务（可选）

**Windows 任务计划程序**：
```batch
# 每日 9:30 自动更新数据
schtasks /create /tn "股票数据更新" /tr "E:\stock_an\stock-picker\update_all_data.py" /sc daily /st 09:30
```

**Linux/Mac crontab**：
```bash
# 每日 9:30 自动更新
30 9 * * * cd /path/to/stock-picker && python update_all_data.py
```

---

## 常见问题

### Q1: 仪表盘的"资金流向"数据为何仍为 0？

**原因**：`fund_flow` 表为空，因为 Tushare API 的资金流向接口需要更高权限。

**解决方案**：
- 升级 Tushare Pro 账户权限
- 或者暂时忽略资金流向指标（买入信号脚本会在无资金数据时将该项评分设为默认值）

### Q2: 为什么分析脚本这么慢？

**原因**：需要逐个股票读取 K 线数据并计算滚动平均（5419 只股票 × 30 天数据）。

**优化建议**：
- 脚本已使用批量数据库操作，已是最优性能
- 可以在数据采集时同步进行分析（未来优化方向）

### Q3: 买入信号的准确性如何？

**说明**：当前买入信号基于**简单规则评分**，不是机器学习模型。评分依据：
- 成交量异常放量 → 高分
- 价格上涨 → 高分
- 主力资金净流入 → 高分

**提示**：
- 仅供参考，不构成投资建议
- 建议结合其他技术指标和基本面分析
- 未来可以训练 ML 模型替换评分逻辑（见 `predictor.py`）

### Q4: 如何验证数据是否正确生成？

**方法 1：查看日志输出**
脚本会显示处理进度和最终统计数据

**方法 2：数据库查询**
```bash
cd stock-picker/data
sqlite3 stock_picker.db

# 检查成交量分析记录数
SELECT COUNT(*) FROM volume_analysis;

# 检查异常放量股票数（最近3天）
SELECT COUNT(*) FROM volume_analysis
WHERE is_volume_surge=1 AND date >= date('now', '-3 days');

# 检查买入信号数（今日）
SELECT COUNT(*) FROM buy_signals
WHERE date(created_at) = date('now');
```

**方法 3：前端查看**
- 打开仪表盘页面（http://localhost:3001）
- 检查统计卡片数据
- 进入"资金分析"页面查看成交量异动列表

---

## 文件说明

| 文件 | 功能 | 耗时 | 依赖 |
|------|------|------|------|
| `download_7days_all_stocks.py` | 批量采集7天数据 | 2分钟 | Tushare API |
| `analyze_all_stocks.py` | 成交量分析 | 13分钟 | `klines` 表 |
| `generate_buy_signals.py` | 买入信号生成 | 2分钟 | `volume_analysis`、`klines` 表 |
| `update_all_data.py` | 一键更新脚本 | 17分钟 | 以上3个脚本 |

---

## 脚本执行状态

当前状态（2025-10-09 19:07）：
- ✅ `download_7days_all_stocks.py` 已完成（5419 条 K 线记录）
- 🔄 `analyze_all_stocks.py` 正在运行（进度 9.2%）
- ⏳ `generate_buy_signals.py` 待运行

预计完成时间：19:20

---

## 后续优化建议

1. **自动化工作流**
   - 在 `download_7days_all_stocks.py` 末尾自动调用分析脚本
   - 或使用 `update_all_data.py` 替代所有手动操作

2. **增量分析**
   - 仅分析新采集的数据，而不是全量分析
   - 可以将 13 分钟缩短至 1 分钟

3. **并行处理**
   - 使用多进程/多线程并行分析多只股票
   - 预计可提速 4-8 倍

4. **机器学习模型**
   - 训练 LSTM/XGBoost 模型替代规则评分
   - 提高买入信号的准确性

---

## 技术支持

如有问题，请检查：
1. 数据库文件路径：`E:\stock_an\stock-picker\data\stock_picker.db`
2. Python 依赖：`pandas`、`aiosqlite`、`loguru`
3. 日志文件：`analysis_log.txt`
4. Tushare Token 配置：`data-service/.env`
