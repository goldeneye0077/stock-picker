# 批量数据采集使用说明

## 功能概述

已实现高效的批量数据采集功能，可以快速下载最近 7 天 A 股全量数据，大幅减少 Tushare API 调用次数。

### 核心优化

- **API 调用次数**：从 5000+ 次降至约 **15 次**
- **下载速度**：从 50 分钟降至约 **2 分钟**
- **API 额度**：仅占用每日 200 次限额的 **7.5%**

## 使用方式

### 方式一：Python 脚本（推荐）

直接运行根目录的批量下载脚本：

```bash
cd stock-picker

# 配置 Tushare Token (首次运行)
# 编辑 data-service/.env 文件，设置 TUSHARE_TOKEN=your_token

# 运行批量下载
python download_7days_all_stocks.py
```

**输出示例**：
```
============================================================
高效批量下载最近 7 天 A 股全量数据
============================================================

正在获取最近 7 天的交易日历...
找到 7 个交易日: 20250930, 20250927, 20250926, ...

============================================================
第 1 步: 下载股票基本信息
============================================================
获取到 5234 只股票
✓ 股票基本信息插入完成，共 5234 只

============================================================
第 2 步: 批量下载日线数据
============================================================
[1/7] 下载 20250930 的日线数据...
  ✓ 成功插入 5102 条K线数据
...

✓ 日线数据下载完成，共 35714 条K线，API调用 7 次

============================================================
第 3 步: 批量下载资金流向数据
============================================================
...
✓ 资金流向数据下载完成，共 35428 条记录，API调用 7 次

============================================================
第 4 步: 生成成交量分析数据
============================================================
✓ 成交量分析完成，生成 24689 条分析记录

============================================================
数据下载完成！
============================================================
✓ 股票数量: 5234 只
✓ K线数据: 35714 条
✓ 资金流向: 35428 条
✓ 成交量分析: 24689 条
✓ API 调用次数: 15 次（远低于 200 次限额）
✓ 总耗时: 132.5 秒
============================================================
```

### 方式二：API 接口调用

通过数据服务的 API 接口触发批量采集：

```bash
# 触发批量采集（包含资金流向）
curl -X POST "http://localhost:8001/api/data/batch-collect-7days"

# 仅采集 K 线数据（不含资金流向）
curl -X POST "http://localhost:8001/api/data/batch-collect-7days?include_moneyflow=false"

# 查看采集状态
curl "http://localhost:8001/api/data/status"
```

**返回示例**：
```json
{
  "success": true,
  "message": "7 天批量数据采集任务已启动，将在后台执行"
}
```

查看服务日志可以看到采集进度：
```bash
# 查看数据服务日志
# 日志会显示实时进度和统计信息
```

## 配置说明

### 1. 配置 Tushare Token

在 `data-service/.env` 文件中配置（首次需创建该文件）：

```bash
# 复制示例配置
cd stock-picker/data-service
cp .env.example .env

# 编辑 .env 文件
# TUSHARE_TOKEN=your_actual_tushare_token_here
```

获取 Token：
1. 访问 https://tushare.pro/
2. 注册并登录账号
3. 在个人中心获取 Token

### 2. API 限频说明

Tushare Pro 限制：
- **每分钟 120 次调用**
- **每天 200 次调用**（免费用户）

批量下载脚本已实现：
- 每次 API 调用间隔 0.5 秒
- 7 天数据仅需约 15 次 API 调用
- 可每天安全运行多次

## 技术原理

### 传统方式（低效）
```
for 每只股票 in 全部5000只股票:
    调用 API 获取该股票的 7 天数据

总计: 5000 次 API 调用
耗时: 约 50 分钟
```

### 批量方式（高效）
```
1. 获取股票列表            -> 1 次 API 调用
2. for 每个交易日 in 7天:
     批量获取所有股票的日线数据  -> 7 次 API 调用
     批量获取所有股票的资金流向  -> 7 次 API 调用（可选）

总计: 约 15 次 API 调用
耗时: 约 2 分钟
```

## 采集的数据内容

### 1. 股票基本信息 (stocks)
- 股票代码、名称
- 交易所、行业分类

### 2. K 线数据 (klines)
- 开盘价、最高价、最低价、收盘价
- 成交量、成交额
- 每只股票最近 7 个交易日的数据

### 3. 资金流向 (fund_flow)
- 主力资金净流入
- 散户资金净流入
- 机构资金流入
- 大单占比

### 4. 成交量分析 (volume_analysis)
- 量比（当日成交量 / 20 日平均成交量）
- 是否异常放量
- 分析结论

## 常见问题

### Q1: 如何判断数据已下载完成？

**方式 1**：检查脚本输出
```bash
python download_7days_all_stocks.py
# 等待输出 "数据下载完成！"
```

**方式 2**：查询 API 状态
```bash
curl "http://localhost:8001/api/data/status"
```

返回示例：
```json
{
  "success": true,
  "data": {
    "total_stocks": 5234,
    "stocks_with_recent_data": 5102,
    "recent_analysis_count": 24689,
    "last_update": "2025-09-30T15:30:00"
  }
}
```

### Q2: 可以只下载特定日期的数据吗？

可以修改脚本中的 `days` 参数：

```python
# 在 download_7days_all_stocks.py 中
trading_days = get_trading_days(tushare_client, days=3)  # 改为 3 天
```

或者使用单独的 API 接口（需要自己实现）。

### Q3: 下载失败怎么办？

**常见原因**：
1. **Token 未配置**：检查 `data-service/.env` 文件
2. **API 超限**：今日已用完 200 次，等待明天
3. **网络问题**：检查网络连接

**解决方法**：
```bash
# 1. 验证 Token 是否正确
echo $TUSHARE_TOKEN

# 2. 查看服务日志
# 数据服务的终端会显示详细错误信息

# 3. 重新运行脚本
# 脚本使用 INSERT OR REPLACE，可以安全重复运行
```

### Q4: 数据更新频率建议？

- **每日收盘后**：建议每天收盘后（15:30 后）运行一次
- **周末不需要**：交易日历会自动跳过非交易日
- **无需频繁更新**：日线数据每天只更新一次

## 定时任务设置（可选）

### Linux/macOS (crontab)

```bash
# 编辑 crontab
crontab -e

# 添加定时任务（每天 16:00 执行）
0 16 * * 1-5 cd /path/to/stock-picker && python download_7days_all_stocks.py >> logs/data_collection.log 2>&1
```

### Windows (任务计划程序)

1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：每天 16:00
4. 操作：启动程序 `python.exe`
5. 参数：`E:\stock_an\stock-picker\download_7days_all_stocks.py`

## API 接口文档

### POST /api/data/batch-collect-7days

批量采集最近 7 天数据

**参数**：
- `include_moneyflow` (bool, 可选)：是否包含资金流向数据，默认 true

**返回**：
```json
{
  "success": true,
  "message": "7 天批量数据采集任务已启动，将在后台执行"
}
```

### GET /api/data/status

查询数据采集状态

**返回**：
```json
{
  "success": true,
  "data": {
    "total_stocks": 5234,
    "stocks_with_recent_data": 5102,
    "recent_analysis_count": 24689,
    "last_update": "2025-09-30T15:30:00"
  }
}
```

## 性能对比

| 指标 | 原方案 | 新方案 | 优化比例 |
|------|--------|--------|---------|
| API 调用次数 | 5000+ 次 | ~15 次 | **99.7% ↓** |
| 下载耗时 | ~50 分钟 | ~2 分钟 | **96% ↓** |
| API 额度占用 | 2500% | 7.5% | **99.7% ↓** |
| 可执行次数/天 | 0 次 | 13 次 | **无限制** |

## 总结

✅ **高效**：15 次 API 调用完成全量数据下载
✅ **快速**：2 分钟内完成，无需漫长等待
✅ **安全**：仅占用 7.5% 每日额度，可多次运行
✅ **智能**：自动跳过非交易日，增量更新
✅ **易用**：一键执行，无需手动操作

现在可以每天轻松获取 A 股全量数据，不再受 API 限制困扰！